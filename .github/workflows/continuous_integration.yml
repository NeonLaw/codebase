---
name: continuous_integration

on:
  push:
    branches:
      - development
      - production
  pull_request:
    branches:
      - development

jobs:
  global_test_suite:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Install Dependencies.
        run: yarn install --ignore-optional
      - name: Run Markdown Linting.
        run: yarn markdown-lint
      - name: Run JavaScript Linting.
        run: yarn lint
      - name: Run TypeScript Type Checking.
        run: yarn check-types
      - name: Test & publish code coverage
        uses: paambaati/codeclimate-action@v2.5.5
        env:
          CC_TEST_REPORTER_ID: ${{secrets.CC_TEST_REPORTER_ID}}
        with:
          coverageCommand: yarn test
      - name: |
          Ensure latest autogenerated graphql-codegen code is up-to-date
          with the staging api.
        run: |
          yarn graphql-codegen -c staging.codegen.yml
          git diff --exit-code
        if: github.ref == '/refs/heads/development'
      - name: |
          Ensure latest autogenerated graphql-codegen code is up-to-date
          with the production api.
        run: |
          yarn graphql-codegen
          git diff --exit-code
        if: github.ref == '/refs/heads/production'
  neon_law_test_suite:
    runs-on: ubuntu-latest
    env:
      AUTH0_CLIENT_ID: ${{ secrets.LOGIC_AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_SECRET: ${{ secrets.LOGIC_AUTH0_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v2
      - name: Run Cypress tests with built application
        uses: cypress-io/github-action@v1
        with:
          start: docker-compose -f ../../neon-law-cypress-docker-compose.yml up
          wait-on: "http://127.0.0.1:8000"
          wait-on-timeout: 1200
          working-directory: ./packages/neon-law
        env:
          CYPRESS_AUTH_URL: ${{ secrets.CYPRESS_AUTH_URL }}
          CYPRESS_AUTH_CLIENT_ID: ${{ secrets.CYPRESS_AUTH_CLIENT_ID }}
          CYPRESS_AUTH_CLIENT_SECRET: ${{ secrets.CYPRESS_AUTH_CLIENT_SECRET }}
          CYPRESS_PORTAL_USER_PASSWORD: ${{ secrets.CYPRESS_PORTAL_USER_PASSWORD }}
  law_job_resources_test_suite:
    runs-on: ubuntu-latest
    env:
      AUTH0_CLIENT_ID: ${{ secrets.LOGIC_AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_SECRET: ${{ secrets.LOGIC_AUTH0_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: yarn
        working-directory: ./packages/law-job-resources
      - name: Build application
        run: yarn build
        working-directory: ./packages/law-job-resources
  justice_for_rickie_slaughter_test_suite:
    runs-on: ubuntu-latest
    env:
      AUTH0_CLIENT_ID: ${{ secrets.LOGIC_AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_SECRET: ${{ secrets.LOGIC_AUTH0_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: yarn
        working-directory: ./packages/justice-for-rickie-slaughter
      - name: Build application
        run: yarn build
        working-directory: ./packages/justice-for-rickie-slaughter
  delete_your_data_test_suite:
    runs-on: ubuntu-latest
    env:
      AUTH0_CLIENT_ID: ${{ secrets.LOGIC_AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_SECRET: ${{ secrets.LOGIC_AUTH0_CLIENT_SECRET }}
    steps:
      - uses: actions/checkout@v2
      - name: Install dependencies
        run: yarn
        working-directory: ./packages/delete-your-data
      - name: Build application
        run: yarn build
        working-directory: ./packages/delete-your-data
